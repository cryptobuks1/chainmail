var MYNODE={},inStart=1,quill=null,loading=!1,ISADMIN=!1,uac=null;function $(t){return document.querySelector(t)}function $$(t){return document.querySelectorAll(t)}function OpenModal(){$("#modalBox").style.display="block",$("#userpass").value="",$("#userpass").focus(),$("#modalBox").onkeyup=function(t){13==t.keyCode&&LogIn()}}function Run(t,e){return new Promise(async(n,a)=>{e||(e={});try{e.method=t;let i=await fetch("/run",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)}),o=await i.json();if(o.login)throw alert("Your new Chainmail is set up\nPlease re-log in to start using Chainmail"),OpenModal(),"Please re-log in";if(o.error)throw o.error.message||o.error;n(o.data)}catch(t){console.error(t),a(t)}})}function Wait(t){document.body.style.cursor=t?"wait":"default"}function ArrayToB64(t){for(var e="",n=new Uint8Array(t),a=n.byteLength,i=0;i<a;i++)e+=String.fromCharCode(n[i]);return window.btoa(e)}function SlideLeft(){return new Promise(t=>{let e=$("#messageList"),n=$("#messageData"),a=$("#mainContainer"),i=340,o=.9*a.offsetWidth,s=0;!function a(){i>20&&(i-=15,e.style.width=i+"px"),s<o&&(s+=15,n.style.width=s+"px"),i<=20&&s>=o?t(!0):setTimeout(a,1)}()})}function SlideRight(){return new Promise(t=>{let e=$("#messageList"),n=$("#messageData"),a=$("#mainContainer"),i=0,o=.9*a.offsetWidth;!function a(){o>0&&(o-=15,n.style.width=o+"px"),i<340&&(i+=15,e.style.width=i+"px"),i>=340&&o<=0?t(!0):setTimeout(a,1)}()})}function Random36(t){var e,n="";for(e=0;e<t;e++){n+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(36*Math.random())]}return n}async function NewMail(){$("#newBtn").style.display="none",$("#inBoxHdr").style.display="none",$("#rBtn").style.display="block",await SlideLeft(),CreateEditor()}async function CloseMessageText(){$("#rBtn").style.display="none",await SlideRight(),$("#newBtn").style.display="block",$("#inBoxHdr").style.display="block",$("#data").innerHTML=""}function CreateEditor(t="\n",e="",n="",a=null,i=""){$("#data").innerHTML="";let o=document.createElement("div");o.id="editorDiv",o.width="100%",o.height="90%";let s=`\n\t\t<p>From: <span id='inpFrom'>${MYNODE.name}</span></p>\n\t\t<p>To:<br><input id='inpTo' style='width:250px;' type='text' value='${n}' size='33'></p>\n\t\t<p>Subject:<br><input id='inpSubj' style='width:95%;' type='text' value='${e}'></p>\n\t\t<div id='editor' class='w3-white' style='height:250px;'></div>\n\t`;s+=a?`<input type='checkbox' id='inc' data-docID='${a}'> Include attachment: <span id='docname'>${i}</span>`:"<p>Attachment:<br><input id='inpAttach' type='file'></p>",s+="\n\t\t<p class='w3-margin-top'>\n\t\t\t<div class='w3-padding w3-right'><button class='w3-button w3-red' onclick='CloseMessageText()'><i class=\"fas fa-ban\"></i> Cancel</button></div>\n\t\t\t<div class='w3-padding w3-right'><button class='w3-button w3-green' onclick='Send()'><i class=\"far fa-paper-plane\"></i> Send</button></div>\n\t\t</p>\n\t",o.innerHTML=s,$("#data").appendChild(o);(quill=new Quill("#editor",{modules:{toolbar:[["bold","italic","underline"],[{size:["small",!1,"large","huge"]}],[{font:[]}],[{align:[]}],["blockquote"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{color:[]},{background:[]}],["clean"]]},placeholder:"Compose an epic...",readOnly:!1,theme:"snow"})).root.innerHTML=t,t.length>2&&quill.insertText(0,""),$("#inpFrom").fontFamily="monospace";let l=$("#inpTo");l.style.fontFamily="monospace",l.onblur=function(t){let e=RegExp("[1-9A-Za-z]","g"),n=l.value;if("@"===n.substr(0,1)&&e.test(n.substr(1)))l.value=l.value.toUpperCase();else{if(12!==(n=(n=n.replace(/\-/g,"")).replace(/ /g,"")).length)return void res.send("ERROR:\nCheck the TO ID");if(!e.test(n))return void res.send({error:"Invalid TO address"});let t=n.substr(0,4),a=n.substr(4,4),i=n.substr(8,4)||"";4==t.length&&(t+="-"),4==a.length&&(a+="-"),l.value=(t+a+i).toUpperCase()}}}async function Send(){Wait(!0);var t="",e=null;try{var n=null,a=!1,i=!1;let o=$("#inpTo").value,s=$("#inpSubj").value,l=quill.root.innerHTML;if($("#inpAttach")&&$("#inpAttach").files.length>0&&(e=$("#inpAttach").files),0==(o=o.trim()).indexOf("@")){o=o.trim(" "),t="Unknown alias";let e=await Run("LookupAlias",{key:o});if(!e)throw"Unkown alias";o=e}else{if(t="Invalid to ID",12!==(o=o.replace(/\-/g,"")).length)throw"Invalid TO ID";let e=o.substr(0,4),n=o.substr(4,4),a=o.substr(8,4);o=e+"-"+n+"-"+a}if(e){t="ERROR:\nAttachement could not be saved",n=await ReadAttachemntFile(e[0]),a=Random36(16),console.log(a),i=e[0].name||!1,t="ERROR:\nError sending attachment";let s={toID:o,fromID:MYNODE.nodeID,docID:a,attachment:n};await Run("SendAttachment",s)}let r=$("#inc");if(r){if(r.checked){a=r.getAttribute("data-docID"),n=await Run("GetAttachment",{docID:a}),t="ERROR:\nError sending attachment",a=Random36(16);let e={toID:o,fromID:MYNODE.nodeID,docID:a,attachment:n};await Run("SendAttachment",e)}}t="ERROR:\nError sending mail";let d={toID:o,fromID:MYNODE.nodeID,subj:"Fwd: "+s,message:l,docID:a,docName:i};await Run("SendMail",d),alert("Success:\nMessage Sent"),await CloseMessageText(),LoadInBox()}catch(e){e?alert("NOTICE:\n"+e):alert("ERROR:\n"+t)}Wait(!1)}function ReadAttachemntFile(t){return new Promise((e,n)=>{var a=new FileReader;a.onload=function(t){e(t.target.result)},a.onerror=function(){console.log(a.error),n(a.error)},a.readAsDataURL(t)})}async function LoadInBox(){if(loading)return;loading=!0;let t=$("#inBox");t.innerHTML="";try{let e,n=await Run("GetInBox",{count:50,start:-1});for(e=0;e<n.length;e++){let a=document.createElement("div");a.style.border="1px solid black",a.classList.add("w3-container");let i=`<div style='padding:6px 8px 6px 2px;' data-txid='${n[e].txid}' class="w3-left far fa-envelope-open fa-2x"></div>`;i+=`<b>From: <span class='mailmsg' data-nodeID='${n[e].fromID}'>${n[e].fromID}</span></b><br>`,i+=`${n[e].timestamp}`,a.innerHTML=i;let o=a.querySelector("div");t.appendChild(a),o.style.cursor="pointer",o.onclick=OpenMessage}GetAlias(),loading=!1}catch(t){loading=!1}}async function GetAlias(){let t,e=$$(".mailmsg");for(t=0;t<e.length;t++){let n=e[t].getAttribute("data-nodeID"),a=await Run("GetAlias",{nodeID:n});a&&(e[t].innerText=a)}}async function OpenMessage(t){$("#data").innerHTML="";let e=t.target.parentNode.querySelector(".mailmsg").innerText,n=t.target.getAttribute("data-txid"),a=await Run("GetMessage",{txid:n});$("#newBtn").style.display="none",$("#inBoxHdr").style.display="none",$("#rBtn").style.display="block",await SlideLeft();let i=document.createElement("div");i.id="editorDiv",i.width="100%",i.height="90%";let o=`\n\t\t<p>From:<br><span id='fromID'>${a.fromID}</span>\n\t`;if("@"==e.substr(0,1)&&(o+=` [${e}]`),o+=`\n\t\t</p>\n\t\t<p>To:<br><span id='toID' data-addr'='${MYNODE.nodeID}'>${MYNODE.nodeID}</span></p>\n\t\t<p>Subject:<br><span id='subj'>${a.subject}</span></p>\n\t\t<p>Timestamp:<br><span id='timestamp'>${a.timestamp}</span></p>\n\t\t<div id='msg' style='height:250px;width:95%;border:1px solid black;overflow-y:auto;' class='w3-container w3-white'>${a.message}</div>\n\t`,a.docID){a.docName.substr(0,64);o+=`\n\t\t\t<div><button id='attach' onclick="OpenAttachment('${a.docID}')"><i class="fas fa-paperclip"></i> ${a.docName}</button>\n\t\t\t</div><br>\n\t\t`}o+=`\t\n\t\t<div class='w3-container'>\n\t\t\t<div class='w3-padding w3-right'><button class='w3-button w3-red' onclick='CloseMessageText()'><i class="far fa-envelope"></i> Close</button></div>\n\t\t\t<div class='w3-padding w3-left'><button class='w3-button w3-green' onclick='Reply()'><i class="fas fa-reply"></i> Reply</button></div>\t\t\n\t\t\t<div class='w3-padding w3-left'><button class='w3-button w3-green' onclick="Forward('${a.docID}')"><i class="fas fa-share"></i> Forward</button></div>\t\t\n\t\t</div>\n\t`,i.innerHTML=o,$("#data").appendChild(i)}async function OpenAttachment(t){Wait(!0);let e=await Run("GetAttachment",{docID:t});window.open(e),Wait(!1)}function Start(){OpenModal()}function Reload(){LoadInBox()}async function LogIn(){let t=null,e=$("#userpass").value;if(uac&&uac!=e)return alert("Codes do not match try again"),uac=null,void OpenModal();let n=await Run("getaddresses");MYNODE.address=n[0],console.log(MYNODE);try{if(t=await Run("nodeinfo",{code:e})){MYNODE.nodeID=t.nodeID,MYNODE.name=MYNODE.nodeID,$("#node").innerHTML=MYNODE.nodeID,inStart=1;let e=await Run("GetAlias",{nodeID:MYNODE.nodeID});e&&($("#node").innerHTML+="<br>"+e.alias+"<br>;"+e.expire),$("#modalBox").style.display="none",ISADMIN=await Run("IsAdmin"),LoadInBox()}else uac=e,alert("Validate your User Access Code"),OpenModal()}catch(t){alert("ERROR\n"+t)}}async function Reply(){let t=$("#msg").innerHTML,e=$("#fromID").innerHTML;CreateEditor(t="\n======== Original Message ========\n"+t,$("#subj").innerHTML,e)}async function Forward(t){let e=$("#msg").innerHTML;CreateEditor(e="\n======== Original Message ========\n"+e,$("#subj").innerHTML,"",t,$("#attach").innerText)}Start();